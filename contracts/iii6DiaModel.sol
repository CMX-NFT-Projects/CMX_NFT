// SPDX-License-Identifier: GPL-3.0
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//
//      MMWKd:..                                                                                    ..:dKWMM
//      MKl.                                                                                            .lKW
//      O'       ..''''''''''''.     .''''''.     .'''''.      .''''''''''''''.     .''''''''''''..       'O
//      '     .ckKNNWNWWWWWWWWWk.   .xNWWNWNl    ,0WWWWW0,     lNWWWWWWWWWNWNk'    ;0NNNWWWWWWWWNNKkc.     '
//           ,OWMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMMMMMMMMM0,    ;KMMMMMMMMMMMMMMMMWO,
//          .kMMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMMMMMMMM0,    ;KMMMMMMMMMMMMMMMMMMMk.
//          '0MMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMMMMMMM0,    :KMMMMMMMMMMMMMMMMMMMM0'
//          '0MMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMMMMMM0,    :KMMMMMMMMMMMMMMMMMMMMM0'
//          '0MMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMMMMM0,    ;0NNWWMMMMMMMMMMMMMMMMMM0'
//          '0MMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMMMM0,     .'.',;lkNMMMMMMMMMMMMMMM0'
//          '0MMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMMMK;              ,kWMMMMMMMMMMMMM0'
//          '0MMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMMX:    .:oxxdc'    .dWMMMMMMMMMMMM0'
//          '0MMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMWd.   ,OWMMMMMXl.   '0MMMMMMMMMMMM0'
//          '0MMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMX;   .kMMMMMMMMK,   .xMMMMMMMMMMMM0'
//          '0MMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMM0'   .OMMMMMMMMX;   .xMMMMMMMMMMMM0'
//          .OMMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMK,    lNMMMMMMWx.   '0MMMMMMMMMMMMO.
//           lNMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMWd.   .:x0KKKkc.   .dWMMMMMMMMMMMNl
//      .    .c0WMMMMMMMMMMMMMMO.   .kMMMMMWo    ,KMMMMMK,     lWMMMMNd.     ....     .xNMMMMMMMMMMW0c.    .
//      l      .,lddxxxxxxxxxxxc.    :xxxxxd,    .lxxxxxl.     ,dxxxxxd:.            .cdxxxxxxxxddl,.      l
//      No.                                                                                              .oN
//      MW0l'                                                                                          'l0WM
//      MMMWKd;.                                                                                    .;dKWMMM
//
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//                                                                                                                                                                                  //
//      @dev            ::              Aron Mauritala Ayuk                                                                                                                                          //
//      @msg            ::              stereo@iii6.xyz                                                                                                                                   //
//      @github         ::              @stereoIII6
//      @twitter        ::              @stereoIII6                                                                                                                                              //
//                                                                                                                                                                                  //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//                                                                                                                                                                                  //
//      @dev            ::              Juan Xavier Valverde                                                                                                                                    //
//      @msg            ::              juanxavier@iii6.xyz                                                                                                                               //
//      @twitter        ::              @JuanXavier                                                                                                                                             //
//      @github         ::              @JuanXavier                                                                                                                                             //
//                                                                                                                                                                                  //                                                                                                                                                                                 //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//  *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//                                                                                                                                                                                  //
//      @company        ::              Fractio Holding                                                                                                                                                                       //
//      @title          ::              iii6 NFT Model                                                                                                                            //
//      @description    ::              ERC721 Model Preset Contract                                                                                                                           //
//      @version        ::              0.0.1                                                                                                                                       //
//      @purpose        ::              ERC20 Model Preset                                                                                                          //
//                                                                                                                                                                                  //
//                                                                                                                                                                                  //
//                                                                                                                                                                                  //
//                                                                                                                                                                                  //
//                                                                                                                                                                                  //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//  *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

pragma solidity ^0.8.7;

import "@openzeppelin/contracts/utils/Counters.sol";
import "@openzeppelin/contracts/utils/Strings.sol";
import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/token/ERC721/IERC721.sol";
import "@openzeppelin/contracts/token/ERC1155/ERC1155.sol";
import "@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol";
import "@chainlink/contracts/src/v0.8/interfaces/LinkTokenInterface.sol";
import "@chainlink/contracts/src/v0.8/interfaces/VRFCoordinatorV2Interface.sol";
import "@chainlink/contracts/src/v0.8/VRFConsumerBaseV2.sol";
import "./iii6VRFConsumer.sol";
import "./iii6Math.sol";
import "./iii6safes.sol";

contract iii6DiaModel is ERC721 {
    address public owner;
    uint256 public minted;
    uint256 public max;
    string public nam;
    string public sym;

    iii6VRFMumbai public vrfMumbai;
    iii6VRFMatic public vrfMatic;

    // token id # => dias obj %
    mapping(uint256 => bytes) public dias;
    // user address @ => nft count #
    mapping(address => uint256) public nftCount;
    // user address @ => nft count # => nft id #
    mapping(address => mapping(uint256 => uint256)) public ntfIdByCount;

    error InvalidAmount();

    constructor(
        address _owner,
        string memory _name,
        string memory _sym
    ) ERC721(_name, _sym) {
        owner = _owner;
        nam = _name;
        sym = _sym;
        max = 1000;
        if (block.chainid == 1) {
            // ETH MAINNET
            // mumbai consumer @ (deploy contract iii6VRFMatic and paste address here)
            // sub @ https://vrf.chain.link/mumbai/320 (go to link and add consumer by pasting address)
            // vrfMatic = iii6VRFMatic(_xOx_); // paste address where _xOx_ and uncomment start of line
        }
        if (block.chainid == 137) {
            // POLYGON MAINNET
            // mumbai consumer @ (deploy contract iii6VRFMatic and paste address here)
            // sub @ https://vrf.chain.link/mumbai/320 (go to link and add consumer by pasting address)
            // vrfMatic = iii6VRFMatic(_xOx_); // paste address where _xOx_ and uncomment start of line
        }
        if (block.chainid == 80001) {
            // POLYGON MUMBAI TESTNET
            // mumbai consumer @ 0x39b6a3aA14a9d34c674389281b09604ECdede228
            // sub @ https://vrf.chain.link/mumbai/2022
            vrfMumbai = iii6VRFMumbai(
                0x39b6a3aA14a9d34c674389281b09604ECdede228
            );
        }
    }

    function isOwner(address _adr) external view returns (bool) {
        return _adr == owner ? true : false;
    }

    function getName() external view returns (string memory) {
        return nam;
    }

    function getSym() external view returns (string memory) {
        return sym;
    }

    function mint(uint256 _amnt) external returns (uint256) {
        if (minted >= max || minted + _amnt >= max) revert InvalidAmount();
        _doMint(_amnt);
        return minted;
    }

    function getVrfId() internal returns (uint256[] memory) {
        uint256 rid = vrfMumbai.requestRandomWords();
        return vrfMumbai.randy(rid);
    }

    function grabIds(uint256 count) external view returns (uint256 ids) {
        return ids = ntfIdByCount[msg.sender][count];
    }

    // @audit. this mints way too much. eg amount is 3
    //@high.
    function _doMint(uint256 _amnt) internal returns (uint256) {
        _mint(msg.sender, minted); // if "minted" is "4" at this point, it will mint 4 to caller
        ++minted; // then update this value

        // this will pass
        if (_amnt >= 2) {
            _mint(msg.sender, minted); // and mint again, this time 5. Up to this point 9 tokens are minted
            minted++;

            if (_amnt >= 3) {
                _mint(msg.sender, minted);
                minted++;

                if (_amnt >= 4) {
                    _mint(msg.sender, minted);
                    minted++;

                    if (_amnt >= 5) {
                        _mint(msg.sender, minted);
                        minted++;

                        if (_amnt >= 6) {
                            _mint(msg.sender, minted);
                            minted++;

                            if (_amnt >= 7) {
                                _mint(msg.sender, minted);
                                minted++;
                            }
                        }
                    }
                }
            }
        }
        return minted;
    }

    function holder(uint256 _id) external view returns (address) {
        return ownerOf(_id);
    }
}
