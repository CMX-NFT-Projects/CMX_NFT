// SPDX-License-Identifier: GPL-3.0
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//
//      MMWKd:..                                                                                    ..:dKWMM
//      MKl.                                                                                            .lKW
//      O'       ..''''''''''''.     .''''''.     .'''''.      .''''''''''''''.     .''''''''''''..       'O
//      '     .ckKNNWNWWWWWWWWWk.   .xNWWNWNl    ,0WWWWW0,     lNWWWWWWWWWNWNk'    ;0NNNWWWWWWWWNNKkc.     '
//           ,OWMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMMMMMMMMM0,    ;KMMMMMMMMMMMMMMMMWO,
//          .kMMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMMMMMMMM0,    ;KMMMMMMMMMMMMMMMMMMMk.
//          '0MMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMMMMMMM0,    :KMMMMMMMMMMMMMMMMMMMM0'
//          '0MMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMMMMMM0,    :KMMMMMMMMMMMMMMMMMMMMM0'
//          '0MMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMMMMM0,    ;0NNWWMMMMMMMMMMMMMMMMMM0'
//          '0MMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMMMM0,     .'.',;lkNMMMMMMMMMMMMMMM0'
//          '0MMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMMMK;              ,kWMMMMMMMMMMMMM0'
//          '0MMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMMX:    .:oxxdc'    .dWMMMMMMMMMMMM0'
//          '0MMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMWd.   ,OWMMMMMXl.   '0MMMMMMMMMMMM0'
//          '0MMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMX;   .kMMMMMMMMK,   .xMMMMMMMMMMMM0'
//          '0MMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMM0'   .OMMMMMMMMX;   .xMMMMMMMMMMMM0'
//          .OMMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMK,    lNMMMMMMWx.   '0MMMMMMMMMMMMO.
//           lNMMMMMMMMMMMMMMMMO.   .kMMMMMWl    ,KMMMMMK,     lWMMMWd.   .:x0KKKkc.   .dWMMMMMMMMMMMNl
//      .    .c0WMMMMMMMMMMMMMMO.   .kMMMMMWo    ,KMMMMMK,     lWMMMMNd.     ....     .xNMMMMMMMMMMW0c.    .
//      l      .,lddxxxxxxxxxxxc.    :xxxxxd,    .lxxxxxl.     ,dxxxxxd:.            .cdxxxxxxxxddl,.      l
//      No.                                                                                              .oN
//      MW0l'                                                                                          'l0WM
//      MMMWKd;.                                                                                    .;dKWMMM
//
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//                                                                                                                                                                                  //
//      @dev            ::              Aron Mauritala Ayuk                                                                                                                                          //
//      @msg            ::              stereo@iii6.xyz                                                                                                                                   //
//      @github         ::              @stereoIII6
//      @twitter        ::              @stereoIII6                                                                                                                                              //
//                                                                                                                                                                                  //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//                                                                                                                                                                                  //
//      @dev            ::              Juan Xavier Valverde                                                                                                                                    //
//      @msg            ::              juanxavier@iii6.xyz                                                                                                                               //
//      @twitter        ::              @JuanXavier                                                                                                                                             //
//      @github         ::              @JuanXavier                                                                                                                                             //
//                                                                                                                                                                                  //                                                                                                                                                                                 //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//  *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//                                                                                                                                                                                  //
//      @company        ::              Fractio Holding                                                                                                                                                                       //
//      @title          ::              iii6 Safes                                                                                                                            //
//      @description    ::              This is a Asset Safe for all Board Members                                                                                                                            //
//      @version        ::              0.0.1                                                                                                                                       //
//      @purpose        ::              Multinet Address Storage                                                                                                           //
//                                                                                                                                                                                  //
//                                                                                                                                                                                  //
//                                                                                                                                                                                  //
//                                                                                                                                                                                  //
//                                                                                                                                                                                  //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//  *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

pragma solidity ^0.8.7;

import "../Assets/iii6CoinModel.sol";
import "../Math/iii6Math.sol";
import "../Misc/iii6Proposals.sol";
import "../Misc/iii6Logs.sol";
import "../Misc/Errors/iii6Errors.sol";

contract iii6SafeVoting is iii6Errors, iii6Proposals {
    // board member id callback from address
    mapping(address => uint256) public memNum;
    // number of board members starting at 1
    uint256 bms;
    // max number of board members starting at 1
    uint256 maxMembers;
    // minimumshare out of 100000
    uint256 minShare;
    // redistribution count
    uint256 rid;
    Proposal[] public proposals;
    iii6CoinModel BoardShares;

    constructor(address payable _shareToken) {
        BoardShares = iii6CoinModel(_shareToken);
    }

    /**
     * @dev allows members to make redistribution proposals
     * @param _members array of board members addresses
     * @param _shares array of share amounts of board members
     * @return exit in bool  makeProposal()
     */

    function proposeRedistribution(
        address[] memory _members,
        uint256[] memory _shares
    ) external returns (bool) {
        if (rid == 0) {
            // first redistribution
            rid = 1;
            // check member count and share count
            if (
                _members.length != bms ||
                _shares.length != bms ||
                bms >= maxMembers
            ) revert All_Slots_Taken();

            return _makeProposal(_members, _shares);
        } else {
            if (
                proposals[rid - 1].state != Voting.Canceled &&
                proposals[rid - 1].state != Voting.Approved
            ) revert Event_Has_Ended();
            if (
                _members.length != bms ||
                _shares.length != bms ||
                bms >= maxMembers
            ) revert All_Slots_Taken();
            return _makeProposal(_members, _shares);
        }
    }

    /**
     * @dev fullfills proposal creation
     * @param _members array of board members addresses
     * @param _shares array of share amounts of board members
     * @return exit in bool true
     */
    function _makeProposal(address[] memory _members, uint256[] memory _shares)
        internal
        returns (bool)
    {
        // create approvals uint[] with numMembers Elements
        bool[] memory approvals;
        int256[] memory difs;
        // check if shares are total < 100000
        uint256 cumu = 0;
        int256 cumud = 0;
        for (uint256 i = 0; i <= _members.length; i++) {
            approvals[i] = false;
            difs[i] =
                int256(BoardShares.balanceOf(_members[i])) -
                int256(_shares[i]);
            cumu += _shares[i];
            cumud += difs[i];
        }
        if (cumu >= 100000 || cumud != 0) revert Invalid_Amount();
        // create first proposal
        proposals[rid] = Proposal(
            rid,
            0,
            _members,
            _shares,
            difs,
            approvals,
            Voting.Active
        );
        rid++;
        return true;
    }

    /**
     * @dev cancels proposal creation and destroys proposal
     * @return exit in bool true
     */
    function cancelProposal() external returns (bool) {
        // Get Last Proposal data
        Proposal memory props = proposals[rid - 1];
        // Set Proposal state canceled
        props.state = Voting.Canceled;
        // exit with check if canceled bool
        proposals[rid - 1] = props;
        return props.state == Voting.Canceled;
    }

    /**
     * @dev allows members to approve proposal creation and
     * in case they have to give away shares transfers those to the contract
     * and afterwards send the sahres to members who are supposed to receive shares
     * @return exit in bool true
     */
    function approveProposal() external returns (bool) {
        // Get Last Proposal data
        Proposal memory props = proposals[rid - 1];
        // Get old balance
        uint256 oldBal = BoardShares.balanceOf(msg.sender);
        // check position to get share amount
        uint256 pos;
        for (uint256 i = 0; i <= props.members.length; i++) {
            if (msg.sender == props.members[i]) pos = i;
        }
        // get share amount
        uint256 newBal = props.shares[pos];
        // get difference old - new to check if approval is needed
        int256 difBal = int256(oldBal) - int256(newBal);
        // check if member recieves (negative diference) or has to move funds (positive diference)
        if (difBal >= 0 && difBal == props.difs[pos]) {
            BoardShares.approve(address(this), uint256(difBal));
        }
        props.votes[pos] = true;
        props.voteCount++;
        bool aT = _allTrue();
        uint256 a = props.members.length;
        if (a == props.voteCount && aT) {
            props.state = Voting.Approved;
            // send tokens to contract
            for (uint256 i = 0; i <= props.members.length; i++) {
                if (props.difs[i] < 0) {
                    BoardShares.transferFrom(
                        props.members[i],
                        address(this),
                        uint256(props.difs[i])
                    );
                }
            }
            // sends tokens to users
            for (uint256 i = 0; i <= props.members.length; i++) {
                if (props.difs[i] >= 0) {
                    BoardShares.transferFrom(
                        address(this),
                        props.members[i],
                        uint256(props.difs[i])
                    );
                }
            }
            proposals[rid - 1] = props;
        }
        return true;
    }

    /**
     * @dev checks if all users approved the proposal
     * @return exit in bool _allTrue
     */
    function _allTrue() internal view returns (bool) {
        // Get Last Proposal data
        Proposal memory props = proposals[rid - 1];
        bool check = true;
        for (uint256 i = 0; i <= props.members.length; i++) {
            if (props.votes[i] == true) check = false;
        }
        return check;
    }
}
